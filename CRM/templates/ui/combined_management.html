{% extends "base_admin.html" %}
{% block content %}
<div class="page-header">
  <div class="page-title">Manage Lead Options</div>
  <div class="quick-actions">
    <button class="btn primary" onclick="openAddStatusModal()">+ Add Status</button>
    <button class="btn primary" onclick="openAddSourceModal()">+ Add Source</button>
  </div>
</div>

{% csrf_token %}

<div class="card">
  <div class="toolbar">
    <div class="input" style="flex:1;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21L15.8 15.8M18 10.5C18 14.09 15.09 17 11.5 17C7.91 17 5 14.09 5 10.5C5 6.91 7.91 4 11.5 4C15.09 4 18 6.91 18 10.5Z" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <input id="searchInput" placeholder="Search statuses and sources..." onkeyup="filterItems()"/>
    </div>
  </div>

  <!-- Side by Side Layout -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
    <!-- Statuses Section -->
    <div>
      <h3 style="margin-bottom: 16px; color: var(--text);">Lead Statuses</h3>
      {% if statuses %}
        <table>
          <thead>
            <tr>
              <th>Status Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="statusTableBody">
            {% for status in statuses %}
              <tr data-item-name="{{ status.name|lower }}" data-item-type="status">
                <td>{{ status.name }}</td>
                <td style="text-align:right; white-space:nowrap;">
                  <button class="btn" onclick="deleteStatus({{ status.id }}, '{{ status.name }}')" title="Delete" style="background-color: #f87171; color: white;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty-state">
          <div>No statuses found</div>
          <button class="btn primary" onclick="openAddStatusModal()">+ Create First Status</button>
        </div>
      {% endif %}
    </div>

    <!-- Sources Section -->
    <div>
      <h3 style="margin-bottom: 16px; color: var(--text);">Lead Sources</h3>
      {% if sources %}
        <table>
          <thead>
            <tr>
              <th>Source Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="sourceTableBody">
            {% for source in sources %}
              <tr data-item-name="{{ source.source|lower }}" data-item-type="source">
                <td>{{ source.source }}</td>
                <td style="text-align:right; white-space:nowrap;">
                  <button class="btn" onclick="deleteSource({{ source.id }}, '{{ source.source }}')" title="Delete" style="background-color: #f87171; color: white;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty-state">
          <div>No sources found</div>
          <button class="btn primary" onclick="openAddSourceModal()">+ Create First Source</button>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add/Edit Status Modal -->
<div id="statusModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="statusModalTitle">Add New Status</h3>
      <button class="close-btn" onclick="closeStatusModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="statusForm">
        <div style="margin-bottom: 15px;">
          <label for="statusName" style="display: block; margin-bottom: 5px; font-weight: 500;">Status Name:</label>
          <input type="text" id="statusName" placeholder="Enter status name..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" required>
        </div>
        <div style="text-align: right;">
          <button type="button" class="btn ghost" onclick="closeStatusModal()">Cancel</button>
          <button type="submit" class="btn primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Source Modal -->
<div id="sourceModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Source</h3>
      <button class="close-btn" onclick="closeSourceModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="sourceForm">
        <div style="margin-bottom: 15px;">
          <label for="sourceName" style="display: block; margin-bottom: 5px; font-weight: 500;">Source Name:</label>
          <input type="text" id="sourceName" placeholder="Enter source name..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" required>
        </div>
        <div style="text-align: right;">
          <button type="button" class="btn ghost" onclick="closeSourceModal()">Cancel</button>
          <button type="submit" class="btn primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let currentStatusId = null;
  
  function openAddStatusModal() {
    currentStatusId = null;
    document.getElementById('statusModalTitle').textContent = 'Add New Status';
    document.getElementById('statusModal').style.display = 'block';
    document.getElementById('statusName').value = '';
  }
  
  
  function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    currentStatusId = null;
  }
  
  function openAddSourceModal() {
    document.getElementById('sourceModal').style.display = 'block';
    document.getElementById('sourceName').value = '';
  }
  
  function closeSourceModal() {
    document.getElementById('sourceModal').style.display = 'none';
  }
  
  function deleteStatus(id, name) {
    if (confirm(`Are you sure you want to delete the status "${name}"?`)) {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
      
      fetch(`/ui/options/statuses/${id}/delete/`, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error deleting status: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error deleting status:', error);
        alert('Error deleting status');
      });
    }
  }
  
  function deleteSource(id, name) {
    if (confirm(`Are you sure you want to delete the source "${name}"?`)) {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
      
      fetch(`/ui/options/sources/${id}/delete/`, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error deleting source: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error deleting source:', error);
        alert('Error deleting source');
      });
    }
  }
  
  
  function filterItems() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
      const itemName = row.getAttribute('data-item-name');
      if (itemName.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }
  
  document.getElementById('statusForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('statusName').value.trim();
    
    if (!name) {
      alert('Please enter a status name');
      return;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('sort_order', '0');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    const url = '/ui/options/statuses/create/';
    
    fetch(url, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeStatusModal();
        location.reload();
      } else {
        alert('Error saving status: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error saving status:', error);
      alert('Error saving status');
    });
  });
  
  document.getElementById('sourceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('sourceName').value.trim();
    
    if (!name) {
      alert('Please enter a source name');
      return;
    }
    
    const formData = new FormData();
    formData.append('source', name);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/ui/options/sources/create/', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeSourceModal();
        location.reload();
      } else {
        alert('Error saving source: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error saving source:', error);
      alert('Error saving source');
    });
  });
  
  // Close modal when clicking outside
  window.onclick = function(event) {
    const statusModal = document.getElementById('statusModal');
    const sourceModal = document.getElementById('sourceModal');
    if (event.target === statusModal) {
      closeStatusModal();
    }
    if (event.target === sourceModal) {
      closeSourceModal();
    }
  }
</script>

<style>
  .modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  
  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .modal-header h3 {
    margin: 0;
    color: #374151;
  }
  
  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #9ca3af;
  }
  
  .close-btn:hover {
    color: #374151;
  }
  
  .modal-body {
    padding: 20px;
  }
</style>
{% endblock %}
