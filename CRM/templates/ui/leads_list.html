{% extends "base_admin.html" %}
{% load lead_filters %}
{% block content %}
{% csrf_token %}

<style>
  /* Dark theme for leads list */
  :root {
    --bg: #000000;
    --card: #1a1a1a;
    --card-soft: #2a2a2a;
    --border: #333333;
    --text: #ffffff;
    --muted: #e0e0e0;
    --primary: #3b82f6;
    --success: #10b981;
    --warning: #fbc02d;
    --danger: #ef4444;
  }

  body {
    background: var(--bg);
    color: var(--text);
  }

  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding: 0 8px;
  }

  .page-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--text);
    margin: 0;
  }

  .quick-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
  }

  .btn.primary {
    background: var(--primary);
    color: white;
  }

  .btn.primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
  }

  .btn.ghost {
    background: var(--card-soft);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn.ghost:hover {
    background: var(--border);
    transform: translateY(-1px);
  }

  .main-card {
    background: var(--card);
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: visible;
  }

  .search-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px;
    border-bottom: 1px solid var(--border);
  }

  .search-input {
    flex: 1;
    position: relative;
  }

  .search-input input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    background: var(--card-soft);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
  }

  .search-input input::placeholder {
    color: var(--muted);
  }

  .search-input svg {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
  }

  .filter-buttons {
    display: flex;
    gap: 8px;
  }

  .table-container {
    overflow-x: auto;
    overflow-y: visible;
    width: 100%;
    position: relative;
  }

  .leads-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }

  .leads-table th {
    background: var(--card-soft);
    color: var(--text);
    font-weight: 600;
    padding: 16px 20px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
  }

  .leads-table th:last-child {
    text-align: center;
  }

  .leads-table td {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
    position: relative;
  }

  .leads-table tr:hover {
    background: var(--card-soft);
  }

  .leads-table tr {
    position: relative;
  }

  .leads-table tr:last-child td {
    border-bottom: none;
  }

  .status-dropdown {
    background: var(--card-soft);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
  }

  .status-chip {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .status-chip.pending {
    background: var(--warning);
    color: #000;
  }

  .status-chip.overdue {
    background: var(--danger);
    color: white;
  }

  .status-chip.completed {
    background: var(--success);
    color: white;
  }

  .status-chip.always-active {
    background: var(--success);
    color: white;
  }

  .status-chip.priority {
    background: #f59e0b;
    color: white;
  }

  .status-chip.inactive {
    background: #6b7280;
    color: white;
  }

  .action-menu-wrapper {
    position: relative;
    display: inline-block;
    z-index: 1;
  }

  .action-menu-wrapper:hover {
    z-index: 10000;
  }

  .action-menu-trigger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: var(--card-soft);
    color: var(--text);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
  }

  .action-menu-trigger:hover {
    background: var(--border);
    transform: translateY(-1px);
  }

  /* Dropdown visibility is now controlled by JavaScript for better hover handling */

  .action-menu-wrapper {
    position: relative;
  }

  .action-menu-dropdown {
    position: fixed;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    min-width: 180px;
    z-index: 99999;
    display: none;
    opacity: 0;
    transform: translateY(-8px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    overflow: hidden;
    pointer-events: auto;
    margin-top: 4px;
  }

  /* Add a small invisible bridge to make hover easier */
  .action-menu-wrapper::after {
    content: '';
    position: absolute;
    bottom: -4px;
    right: 0;
    width: 100%;
    height: 8px;
    background: transparent;
    z-index: 99998;
  }

  .action-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 16px;
    background: transparent;
    border: none;
    color: var(--text);
    text-decoration: none;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: left;
  }

  .action-menu-item:hover {
    background: var(--card-soft);
    color: var(--primary);
  }

  .action-menu-item.danger {
    color: var(--danger);
  }

  .action-menu-item.danger:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #fca5a5;
  }

  .action-menu-item svg {
    flex-shrink: 0;
    opacity: 0.8;
  }

  .action-menu-item:hover svg {
    opacity: 1;
  }

  .action-menu-item span {
    flex: 1;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .empty-state h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: var(--text);
  }

  .empty-state p {
    margin: 0;
    font-size: 14px;
  }

  /* Column customization dropdown */
  .column-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    z-index: 1000;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,.3);
    min-width: 280px;
    max-width: 320px;
    max-height: 400px;
    margin-top: 8px;
    overflow: hidden;
  }

  .column-dropdown-content {
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .column-dropdown-header {
    padding: 16px 16px 12px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .column-options-container {
    flex: 1;
    overflow-y: auto;
    padding: 0 16px;
    max-height: 250px;
  }

  .column-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding: 16px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  /* Custom scrollbar styling */
  .column-options-container::-webkit-scrollbar {
    width: 6px;
  }

  .column-options-container::-webkit-scrollbar-track {
    background: var(--card-soft);
    border-radius: 3px;
  }

  .column-options-container::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  .column-options-container::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }

  .table-container::-webkit-scrollbar {
    height: 8px;
  }

  .table-container::-webkit-scrollbar-track {
    background: var(--card-soft);
    border-radius: 4px;
  }

  .table-container::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }

  .table-container::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    
    .quick-actions {
      width: 100%;
      justify-content: flex-start;
    }
    
    .leads-table {
      min-width: 1000px;
    }
  }

  @media (max-width: 768px) {
    .page-header {
      padding: 0 4px;
      margin-bottom: 16px;
    }
    
    .page-title {
      font-size: 24px;
    }
    
    .quick-actions {
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
    
    .btn {
      justify-content: center;
      padding: 12px 16px;
    }
    
    .search-toolbar {
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }
    
    .search-input {
      width: 100%;
    }
    
    .filter-buttons {
      justify-content: center;
    }
    
    .leads-table {
      min-width: 800px;
    }
    
    .action-menu-trigger {
      width: 28px;
      height: 28px;
    }
    
    .action-menu-dropdown {
      min-width: 160px;
    }
    
    .action-menu-item {
      padding: 10px 14px;
      font-size: 13px;
    }
    
    .column-dropdown {
      min-width: 260px;
      max-width: 280px;
    }
  }

  @media (max-width: 480px) {
    .page-title {
      font-size: 20px;
    }
    
    .btn {
      padding: 10px 12px;
      font-size: 13px;
    }
    
    .search-input input {
      padding: 10px 12px 10px 40px;
      font-size: 14px;
    }
    
    .leads-table {
      min-width: 600px;
    }
    
    .leads-table th,
    .leads-table td {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .action-menu-trigger {
      width: 24px;
      height: 24px;
    }
    
    .action-menu-dropdown {
      min-width: 140px;
    }
    
    .action-menu-item {
      padding: 8px 12px;
      font-size: 12px;
    }
    
    .status-chip {
      padding: 2px 8px;
      font-size: 10px;
    }
    
    .column-dropdown {
      min-width: 240px;
      max-width: 260px;
    }
    
    .column-dropdown-content {
      max-height: 300px;
    }
    
    .column-options-container {
      max-height: 200px;
    }
  }

  @media (max-width: 360px) {
    .page-title {
      font-size: 18px;
    }
    
    .btn {
      padding: 8px 10px;
      font-size: 12px;
    }
    
    .leads-table {
      min-width: 500px;
    }
    
    .leads-table th,
    .leads-table td {
      padding: 6px 8px;
      font-size: 12px;
    }
    
    .action-menu-trigger {
      width: 20px;
      height: 20px;
    }
    
    .action-menu-dropdown {
      min-width: 120px;
    }
    
    .action-menu-item {
      padding: 6px 10px;
      font-size: 11px;
    }
  }

  .column-dropdown h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .column-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .column-option:hover {
    color: var(--primary);
  }

  .column-option input[type="checkbox"] {
    margin: 0;
    accent-color: var(--primary);
  }

  .column-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .column-customization {
    position: relative;
    display: inline-block;
  }

  /* Notes Modal Styles */
  .notes-modal {
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
  }

  .notes-modal-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .notes-modal-content {
    position: relative;
    background: #1a1a1a;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 700px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease-out;
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .notes-modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .notes-modal-title {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .notes-modal-title svg {
    flex-shrink: 0;
  }

  .notes-modal-title h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: white;
  }

  .notes-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    color: white;
    padding: 0;
  }

  .notes-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .notes-modal-body {
    padding: 24px;
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
  }

  .notes-list {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 20px;
    padding-right: 8px;
    min-height: 200px;
    max-height: 400px;
  }

  .notes-list::-webkit-scrollbar {
    width: 6px;
  }

  .notes-list::-webkit-scrollbar-track {
    background: var(--card-soft);
    border-radius: 10px;
  }

  .notes-list::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 10px;
  }

  .notes-list::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }

  .notes-loading {
    text-align: center;
    color: var(--muted);
    padding: 40px 20px;
    font-size: 14px;
  }

  .note-item {
    background: var(--card-soft);
    border-left: 3px solid #667eea;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
    animation: slideIn 0.3s ease-out;
  }

  .note-item:hover {
    background: var(--border);
    transform: translateX(4px);
  }

  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .note-author {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--text);
    font-size: 14px;
  }

  .note-author-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
    flex-shrink: 0;
  }

  .note-time {
    font-size: 12px;
    color: var(--muted);
    font-weight: 400;
  }

  .note-message {
    color: var(--muted);
    line-height: 1.6;
    font-size: 14px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .notes-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .notes-empty svg {
    width: 64px;
    height: 64px;
    margin: 0 auto 16px;
    opacity: 0.5;
  }

  .notes-form {
    border-top: 1px solid var(--border);
    padding-top: 20px;
  }

  .notes-input-wrapper {
    margin-bottom: 12px;
  }

  .notes-input-wrapper textarea {
    width: 100%;
    min-height: 100px;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    transition: all 0.2s;
    background: var(--card-soft);
    color: var(--text);
  }

  .notes-input-wrapper textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .notes-form-actions {
    display: flex;
    justify-content: flex-end;
  }

  .notes-submit-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .notes-submit-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .notes-submit-btn:active {
    transform: translateY(0);
  }

  .notes-submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .notes-error {
    background: rgba(239, 68, 68, 0.1);
    border-left-color: #ef4444;
    color: #fca5a5;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 14px;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes slideIn {
    from {
      transform: translateX(-10px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
</style>

<div class="page-header">
  <h1 class="page-title">Open Leads</h1>
  <div class="quick-actions">
    <div class="column-customization">
      {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}
        <a class="btn ghost" href="{% url 'ui-leads-export' %}{% if request.GET.q %}?q={{ request.GET.q }}{% endif %}" title="Export to CSV">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Export CSV
        </a>
      {% endif %}
      <button class="btn ghost" onclick="toggleColumnCustomization()" id="customize-btn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 6h18M7 12h10M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Customize Columns
      </button>
      <div class="column-dropdown" id="column-dropdown" style="display: none;">
        <div class="column-dropdown-content">
          <div class="column-dropdown-header">
            <h4>Select Columns to Display</h4>
          </div>
          <form id="column-form">
            {% csrf_token %}
            <div class="column-options-container">
              {% for column_key, column_label in available_columns.items %}
                <label class="column-option">
                  <input type="checkbox" name="columns" value="{{ column_key }}" 
                         {% if column_key in visible_columns %}checked{% endif %}>
                  <span>{{ column_label }}</span>
                </label>
              {% endfor %}
            </div>
            <div class="column-actions">
              <button type="button" class="btn primary" onclick="applyColumnChanges()">Apply</button>
              <button type="button" class="btn ghost" onclick="resetColumns()">Reset to Default</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}
      <a class="btn primary" href="/ui/leads/new/">+ New Lead</a>
    {% endif %}
  </div>
</div>

<div class="main-card">
  <div class="search-toolbar">
    <div class="search-input">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 21L15.8 15.8M18 10.5C18 14.09 15.09 17 11.5 17C7.91 17 5 14.09 5 10.5C5 6.91 7.91 4 11.5 4C15.09 4 18 6.91 18 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <form method="get">
      <input name="q" placeholder="Search by name, company, or email..." value="{{ request.GET.q }}"/>
    </form>
    </div>
    <div class="filter-buttons">
      <a class="btn ghost" href="?">Reset</a>
    </div>
  </div>

{% if leads %}
    <div class="table-container">
      <table class="leads-table">
    <thead>
      <tr>
            {% for column_key in visible_columns %}
              <th class="column-{{ column_key }}">
                {{ available_columns|lookup:column_key }}
              </th>
            {% endfor %}
            <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for lead in leads %}
        <tr>
              {% for column_key in visible_columns %}
                <td class="column-{{ column_key }}">
                  {% include "ui/leads/column_cell.html" with column_key=column_key lead=lead %}
                </td>
              {% endfor %}
              <td>
                <div class="action-menu-wrapper">
                  <button class="action-menu-trigger" title="Actions">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="1" fill="currentColor"/>
                      <circle cx="12" cy="5" r="1" fill="currentColor"/>
                      <circle cx="12" cy="19" r="1" fill="currentColor"/>
                    </svg>
                  </button>
                  <div class="action-menu-dropdown">
                    <button class="action-menu-item" onclick="openNotesModal({{ lead.pk }}, '{{ lead.title|escapejs }}')">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                      </svg>
                      <span>Notes</span>
                    </button>
                    <a href="/ui/leads/{{ lead.pk }}/" class="action-menu-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                      <span>View</span>
                    </a>
                    <a href="/ui/leads/{{ lead.pk }}/edit/" class="action-menu-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                      <span>Edit</span>
                    </a>
                    {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}
                      <button class="action-menu-item" onclick="toggleProject({{ lead.pk }})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          {% if lead.is_project %}
                            <path d="M18 6L6 18M6 6l12 12"></path>
                          {% else %}
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"></path>
                          {% endif %}
                        </svg>
                        <span>{% if lead.is_project %}Convert to Lead{% else %}Convert to Project{% endif %}</span>
                      </button>
                    {% endif %}
                    <a href="/ui/leads/{{ lead.pk }}/delete/" class="action-menu-item danger">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M10 11v6M14 11v6"></path>
                      </svg>
                      <span>Delete</span>
                    </a>
                  </div>
                </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
    </div>
{% else %}
  <div class="empty-state">
      <h3>No leads found</h3>
      <p>Try adjusting your search criteria or create a new lead.</p>
  </div>
{% endif %}
</div>

<!-- Notes Modal -->
<div id="notesModal" class="notes-modal" style="display: none;">
  <div class="notes-modal-overlay" onclick="closeNotesModal()"></div>
  <div class="notes-modal-content">
    <div class="notes-modal-header">
      <div class="notes-modal-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <h3 id="notesModalTitle">Notes</h3>
      </div>
      <button class="notes-close-btn" onclick="closeNotesModal()" aria-label="Close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="notes-modal-body">
      <div id="notesList" class="notes-list">
        <div class="notes-loading">Loading notes...</div>
      </div>
      <form id="noteForm" class="notes-form">
        {% csrf_token %}
        <div class="notes-input-wrapper">
          <textarea 
            id="noteMessage" 
            name="message" 
            placeholder="Type your note here..." 
            rows="3"
            required></textarea>
        </div>
        <div class="notes-form-actions">
          <button type="submit" class="notes-submit-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            Send Note
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let currentLeadId = null;

function openNotesModal(leadId, leadTitle) {
  currentLeadId = leadId;
  const modal = document.getElementById('notesModal');
  const titleElement = document.getElementById('notesModalTitle');
  titleElement.textContent = `Notes - ${leadTitle}`;
  modal.style.display = 'flex';
  loadNotes();
  // Focus on textarea after a short delay
  setTimeout(() => {
    const textarea = document.getElementById('noteMessage');
    if (textarea) textarea.focus();
  }, 300);
}

function closeNotesModal() {
  document.getElementById('notesModal').style.display = 'none';
  currentLeadId = null;
  // Clear the form
  const form = document.getElementById('noteForm');
  if (form) form.reset();
}

function loadNotes() {
  if (!currentLeadId) return;
  
  const notesList = document.getElementById('notesList');
  notesList.innerHTML = '<div class="notes-loading">Loading notes...</div>';
  
  fetch(`/ui/leads/${currentLeadId}/notes/`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to load notes');
      }
      return response.json();
    })
    .then(data => {
      if (data.notes && data.notes.length > 0) {
        notesList.innerHTML = data.notes.map(note => {
          const authorInitials = note.author_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
          const escapedMessage = note.message.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
          return `
            <div class="note-item">
              <div class="note-header">
                <div class="note-author">
                  <div class="note-author-avatar">${authorInitials}</div>
                  <span>${note.author_name}</span>
                </div>
                <div class="note-time">${note.created_on_arrow}</div>
              </div>
              <div class="note-message">${escapedMessage}</div>
            </div>
          `;
        }).join('');
        // Scroll to bottom
        notesList.scrollTop = notesList.scrollHeight;
      } else {
        notesList.innerHTML = `
          <div class="notes-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <p>No notes yet. Be the first to add one!</p>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Error loading notes:', error);
      notesList.innerHTML = '<div class="notes-error">Error loading notes. Please try again.</div>';
    });
}

document.getElementById('noteForm').addEventListener('submit', function(e) {
  e.preventDefault();
  if (!currentLeadId) return;
  
  const messageInput = document.getElementById('noteMessage');
  const message = messageInput.value.trim();
  const submitBtn = this.querySelector('.notes-submit-btn');
  
  if (!message) {
    messageInput.focus();
    return;
  }
  
  // Disable submit button
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Sending...';
  
  const formData = new FormData();
  formData.append('message', message);
  formData.append('csrfmiddlewaretoken', document.querySelector('input[name="csrfmiddlewaretoken"]').value);
  
  fetch(`/ui/leads/${currentLeadId}/notes/`, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(data => {
        throw new Error(data.error || data.errors || 'Failed to add note');
      });
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      messageInput.value = '';
      loadNotes();
      // Show success feedback
      submitBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Sent!';
      setTimeout(() => {
        submitBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> Send Note';
        submitBtn.disabled = false;
      }, 1000);
    } else {
      throw new Error(data.error || data.errors || 'Unknown error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    const notesList = document.getElementById('notesList');
    notesList.insertAdjacentHTML('afterbegin', `<div class="notes-error">Error: ${error.message}</div>`);
    setTimeout(() => {
      const errorDiv = notesList.querySelector('.notes-error');
      if (errorDiv) errorDiv.remove();
    }, 5000);
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> Send Note';
  });
});

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('notesModal');
    if (modal && modal.style.display !== 'none') {
      closeNotesModal();
    }
  }
});

function toggleColumnCustomization() {
    const dropdown = document.getElementById('column-dropdown');
    const customizeBtn = document.getElementById('customize-btn');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    customizeBtn.classList.toggle('active');
  }

  function applyColumnChanges() {
    const form = document.getElementById('column-form');
    const formData = new FormData(form);
    const selectedColumns = Array.from(formData.getAll('columns'));
    
    
    // Get CSRF token from the form
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
      alert('CSRF token not found. Please refresh the page and try again.');
      return;
    }
    
    // Store in session
    fetch('{% url "ui-leads-customize-columns" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': csrfToken.value,
      }
    })
    .then(response => {
      if (response.ok) {
        window.location.reload();
      } else {
        alert('Error updating columns. Please try again.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating columns: ' + error.message);
    });
  }

  function resetColumns() {
    // Reset to default columns
    const defaultColumns = ['title', 'status', 'follow_up_at', 'follow_up_status', 'always_active'];
    
    // Uncheck all
    document.querySelectorAll('input[name="columns"]').forEach(cb => {
      cb.checked = false;
    });
    
    // Check default columns
    defaultColumns.forEach(column => {
      const checkbox = document.querySelector(`input[name="columns"][value="${column}"]`);
      if (checkbox) {
        checkbox.checked = true;
      }
    });
  }

  function toggleProject(leadId) {
    fetch(`/ui/leads/${leadId}/toggle-project/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      }
    })
      .then(response => response.json())
      .then(data => {
      if (data.success) {
        window.location.reload();
        } else {
        alert('Error: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
      console.error('Error:', error);
      alert('Error updating project status');
    });
  }

  function updateLeadStatus(leadId, status) {
    const formData = new FormData();
    formData.append('status', status);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/ui/leads/${leadId}/lead-status/`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        // Update the select element to show the new status
        const selectElement = document.querySelector(`select[onchange*="${leadId}"]`);
        if (selectElement) {
          selectElement.value = status;
        }
      } else {
        alert('Error updating lead status: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error updating lead status:', error);
      alert('Error updating lead status');
    });
  }

  function updateAssignedTo(leadId, assignedToId, selectElement) {
    // If selectElement is not passed, find it
    if (!selectElement) {
      selectElement = document.querySelector(`select[onchange*="updateAssignedTo('${leadId}'"]`);
    }
    
    if (!selectElement) {
      console.error('Could not find select element for lead', leadId);
      return;
    }
    
    // Store the previous value before making the change
    const previousValue = selectElement.getAttribute('data-previous-value') || '';
    
    const formData = new FormData();
    formData.append('assigned_to', assignedToId);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/ui/leads/${leadId}/assign/`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Successfully updated - store current value as previous for next change
        selectElement.setAttribute('data-previous-value', assignedToId);
        console.log('Lead assignment updated successfully');
      } else {
        alert('Error updating assignment: ' + (data.error || 'Unknown error'));
        // Revert the dropdown to the previous value on error
        selectElement.value = previousValue;
      }
    })
    .catch(error => {
      console.error('Error updating assignment:', error);
      alert('Error updating assignment');
      // Revert the dropdown to the previous value on error
      selectElement.value = previousValue;
    });
  }

  function toggleAlwaysActive(leadId) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/ui/leads/${leadId}/toggle-always-active/`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Reload the page to update the UI
        location.reload();
      } else {
        alert('Error updating always active status: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error updating always active status:', error);
      alert('Error updating always active status');
    });
  }

  function togglePriority(leadId) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/ui/leads/${leadId}/toggle-priority/`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Reload the page to update the UI
        location.reload();
      } else {
        alert('Error updating priority status: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error updating priority status:', error);
      alert('Error updating priority status');
    });
  }

  function updateFollowUpStatus(leadId, status) {
    const formData = new FormData();
    formData.append('status', status);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/ui/leads/${leadId}/status/`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        // Update the select element to show the new status
        const selectElement = document.getElementById(`status-select-${leadId}`);
        if (selectElement) {
          selectElement.value = status;
        }
      } else {
        alert('Error updating follow-up status: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error updating follow-up status:', error);
      alert('Error updating follow-up status');
    });
  }

  // Position action menu dropdowns on hover with delay
  let hoverTimeout = null;
  let activeDropdown = null;

  document.querySelectorAll('.action-menu-wrapper').forEach(wrapper => {
    const trigger = wrapper.querySelector('.action-menu-trigger');
    const dropdown = wrapper.querySelector('.action-menu-dropdown');
    
    if (trigger && dropdown) {
      // Show dropdown on mouseenter
      wrapper.addEventListener('mouseenter', function() {
        clearTimeout(hoverTimeout);
        activeDropdown = dropdown;
        const rect = trigger.getBoundingClientRect();
        dropdown.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        dropdown.style.right = (window.innerWidth - rect.right) + 'px';
        dropdown.style.display = 'block';
        setTimeout(() => {
          dropdown.style.opacity = '1';
          dropdown.style.transform = 'translateY(0)';
        }, 10);
      });

      // Keep dropdown open when hovering over it
      dropdown.addEventListener('mouseenter', function() {
        clearTimeout(hoverTimeout);
        activeDropdown = dropdown;
      });

      // Hide dropdown on mouseleave with delay
      wrapper.addEventListener('mouseleave', function() {
        hoverTimeout = setTimeout(() => {
          if (activeDropdown === dropdown) {
            dropdown.style.opacity = '0';
            dropdown.style.transform = 'translateY(-8px)';
            setTimeout(() => {
              dropdown.style.display = 'none';
              activeDropdown = null;
            }, 200);
          }
        }, 200);
      });

      dropdown.addEventListener('mouseleave', function() {
        hoverTimeout = setTimeout(() => {
          if (activeDropdown === dropdown) {
            dropdown.style.opacity = '0';
            dropdown.style.transform = 'translateY(-8px)';
            setTimeout(() => {
              dropdown.style.display = 'none';
              activeDropdown = null;
            }, 200);
          }
        }, 200);
      });
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('column-dropdown');
    const customizeBtn = document.getElementById('customize-btn');
    const modal = document.getElementById('notesModal');
    
    // Handle column dropdown
    if (dropdown && customizeBtn && !dropdown.contains(event.target) && !customizeBtn.contains(event.target)) {
      dropdown.style.display = 'none';
      customizeBtn.classList.remove('active');
    }
    
    // Handle notes modal overlay
    if (modal && event.target.classList.contains('notes-modal-overlay')) {
      closeNotesModal();
    }

    // Close action menus when clicking outside
    if (!event.target.closest('.action-menu-wrapper')) {
      document.querySelectorAll('.action-menu-dropdown').forEach(menu => {
        menu.style.display = 'none';
        menu.style.opacity = '0';
      });
    }
  });
</script>

{% endblock %}