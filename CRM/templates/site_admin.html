{% extends "base_admin.html" %}
{% block content %}
{% csrf_token %}
<form class="topbar" method="get" action="/">
  <div class="search" style="width:100%; max-width:560px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M21 21L15.8 15.8M18 10.5C18 14.09 15.09 17 11.5 17C7.91 17 5 14.09 5 10.5C5 6.91 7.91 4 11.5 4C15.09 4 18 6.91 18 10.5Z"
        stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
    <input name="q" value="{{ q }}" placeholder="Search leads by title, company, or contact... (press Enter)" />
  </div>
  <div class="quick-actions">
    <a class="btn" href="/ui/leads/">View Leads</a>
    {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}
      <a class="btn primary" href="/ui/leads/new/">+ New Lead</a>
    {% endif %}
    <a class="btn" href="/reminders/">Reminders</a>
  </div>
</form>

<section class="row" style="margin-bottom:14px;">
  <div class="span-4 card">
    <h3>
      {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}Lead Overview{% elif request.user.profile.role|add:"0" == ROLE_EMPLOYEE_VALUE %}My Leads{% elif request.user.profile.role|add:"0" == UserRole.DEV_LEAD %}Development Leads{% endif %}
    </h3>
    <div class="grid" style="grid-template-columns: repeat(2, 1fr); gap:12px;">
      <div class="kpi">
        <h3>Total Leads</h3>
        <div class="value">{{ total_leads }}</div>
      </div>
      <div class="kpi">
        <h3>Open Follow-ups</h3>
        <div class="value" style="color: #f59e0b;">{{ follow_up_counts.pending }}</div>
      </div>
      <div class="kpi">
        <h3>Completed</h3>
        <div class="value" style="color: #10b981;">{{ follow_up_counts.done }}</div>
      </div>
      <div class="kpi">
        <h3>Companies</h3>
        <div class="value">{{ companies_count }}</div>
      </div>
    </div>
  </div>
  
  <div class="span-5 card">
    <h3>Lead Status Breakdown</h3>
    <div class="list">
      {% for status, count in status_counts.items %}
        {% if count > 0 %}
        <div class="list-item">
          <div>
            <div class="title">{{ status|title }}</div>
            <div class="meta">{{ count }} leads</div>
          </div>
          <span class="chip">{{ count }}</span>
        </div>
        {% endif %}
      {% empty %}
        <div class="muted">No leads with status</div>
      {% endfor %}
    </div>
  </div>
  
  <div class="span-3 card">
    <h3>Quick Actions</h3>
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
      {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}
        <a class="btn primary" href="/ui/leads/new/">+ New Lead</a>
        <a class="btn" href="/add-employee/">+ Employee</a>
        <a class="btn" href="/manage-lead-options/">Manage Options</a>
        <a class="btn" href="/test-email/">Test Email</a>
      {% elif request.user.profile.role|add:"0" == ROLE_EMPLOYEE_VALUE %}
        <a class="btn" href="/reminders/">My Reminders</a>
        <a class="btn" href="/ui/leads/">My Leads</a>
      {% elif request.user.profile.role|add:"0" == UserRole.DEV_LEAD %}
        <a class="btn" href="/ui/leads/">Development Leads</a>
      {% endif %}
      <a class="btn" href="/reminders/">View Reminders</a>
      <a class="btn" href="/ui/leads/">All Leads</a>
    </div>
  </div>
</section>

<section class="row" style="margin-bottom:14px;">
  <div class="span-6 card">
    <h3>
      {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}All Leads Over Time{% elif request.user.profile.role|add:"0" == ROLE_EMPLOYEE_VALUE %}My Leads Over Time{% elif request.user.profile.role|add:"0" == UserRole.DEV_LEAD %}Development Leads Over Time{% endif %}
    </h3>
    <div class="chart" style="padding:10px;">
      <canvas id="leadsOverTimeChart" data-labels='{{ leads_over_time_labels_json|safe }}'
        data-counts='{{ leads_over_time_counts_json|safe }}' style="width:100%; height:100%;"></canvas>
    </div>
  </div>
  
  <div class="span-6 card">
    <h3>
      {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}Team Analytics{% elif request.user.profile.role|add:"0" == ROLE_EMPLOYEE_VALUE %}My Analytics{% elif request.user.profile.role|add:"0" == UserRole.DEV_LEAD %}Development Analytics{% endif %}
    </h3>
    <div class="list">
      {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}
        <div class="list-item">
          <div>
            <div class="title">My Assigned Leads</div>
            <div class="meta">{{ my_leads_count }} leads assigned to me</div>
          </div>
          <span class="chip">{{ my_leads_count }}</span>
        </div>
        <div class="list-item">
          <div>
            <div class="title">Assigned to Team</div>
            <div class="meta">{{ assigned_leads_count }} leads assigned to team</div>
          </div>
          <span class="chip">{{ assigned_leads_count }}</span>
        </div>
        <div class="list-item">
          <div>
            <div class="title">Unassigned</div>
            <div class="meta">{{ unassigned_leads_count }} leads need assignment</div>
          </div>
          <span class="chip" style="background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.35); color: #ef4444;">{{ unassigned_leads_count }}</span>
        </div>
      {% elif request.user.profile.role|add:"0" == ROLE_EMPLOYEE_VALUE %}
        <div class="list-item">
          <div>
            <div class="title">My Leads</div>
            <div class="meta">{{ my_leads_count }} leads assigned to me</div>
          </div>
          <span class="chip">{{ my_leads_count }}</span>
        </div>
        <div class="list-item">
          <div>
            <div class="title">Pending Follow-ups</div>
            <div class="meta">{{ my_pending_leads }} need attention</div>
          </div>
          <span class="chip" style="background: rgba(251,191,36,.15); border-color: rgba(251,191,36,.35); color: #fbbf24;">{{ my_pending_leads }}</span>
        </div>
        <div class="list-item">
          <div>
            <div class="title">Completed Tasks</div>
            <div class="meta">{{ follow_up_counts.done }} follow-ups completed</div>
          </div>
          <span class="chip" style="background: rgba(52,211,153,.15); border-color: rgba(52,211,153,.35); color: #34d399;">{{ follow_up_counts.done }}</span>
        </div>
      {% elif request.user.profile.role|add:"0" == UserRole.DEV_LEAD %}
        <div class="list-item">
          <div>
            <div class="title">Development Leads</div>
            <div class="meta">{{ total_leads }} leads in development</div>
          </div>
          <span class="chip">{{ total_leads }}</span>
        </div>
        <div class="list-item">
          <div>
            <div class="title">Companies</div>
            <div class="meta">{{ companies_count }} companies in development</div>
          </div>
          <span class="chip">{{ companies_count }}</span>
        </div>
      {% endif %}
    </div>
  </div>
</section>
{% load debug %}

<h3>Debug Context Dump</h3>
<pre>
{% debug %}
</pre>

<section class="row" style="margin-bottom:14px;">
  <div class="span-6 card">
    <h3>
      {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}Recent Activity{% elif request.user.profile.role|add:"0" == ROLE_EMPLOYEE_VALUE %}My Recent Activity{% elif request.user.profile.role|add:"0" == UserRole.DEV_LEAD %}Development Activity{% endif %}
    </h3>
    <table>
      <thead>
        <tr>
          <th>When</th>
          <th>Item</th>
          <th>Action</th>
          <th>Owner</th>
        </tr>
      </thead>
      <tbody>
        {% for a in recent_activity %}
        <tr>
          <td>{{ a.when|date:"M d, g:i A" }}</td>
          <td>{{ a.item }}</td>
          <td>{{ a.action }}</td>
          <td>{{ a.owner }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="muted">No recent activity</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div class="span-6 card">
    <h3>
      {% if request.user.profile.role|add:"0" == ROLE_MANAGER_VALUE %}Upcoming Reminders{% elif request.user.profile.role|add:"0" == ROLE_EMPLOYEE_VALUE %}My Upcoming Reminders{% elif request.user.profile.role|add:"0" == UserRole.DEV_LEAD %}Development Reminders{% endif %}
    </h3>
    <div class="list">
      {% for r in upcoming_reminders %}
      <div class="list-item">
        <div>
          <div class="title">{{ r.title }}</div>
          <div class="meta">{{ r.follow_up_at|date:"M d, g:i A" }} • {{ r.follow_up_status|capfirst }}</div>
        </div>
        <a class="btn" href="/ui/leads/{{ r.pk }}/">View</a>
      </div>
      {% empty %}
      <div class="muted">No upcoming reminders</div>
      {% endfor %}
    </div>
  </div>
</section>

{% if recent_notes %}
<section class="row" style="margin-bottom:14px;">
  <div class="span-12 card">
    <h3>Unread Notes</h3>
    <div class="list">
      {% for note in recent_notes %}
      <div class="list-item">
        <div>
          <div class="title">{{ note.lead.title }}</div>
          <div class="meta">{{ note.author.user.first_name|default:note.author.user.email }} • {{ note.created_at|date:"M d, g:i A" }}</div>
          <div style="margin-top: 8px; color: #6b7280; font-size: 13px;">{{ note.message|truncatechars:100 }}</div>
        </div>
        <button class="btn" onclick="openNotesModal('{{ note.lead.pk }}', '{{ note.lead.title }}')">View Notes</button>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

<section class="row" style="margin-bottom:14px;">
  <div class="span-12 card">
    <h3>Unread Notes</h3>
    <div class="list">
      {% for note in recent_notes %}
      <div class="list-item">
        <div style="flex: 1;">
          <div class="title">{{ note.lead.title }}</div>
          <div class="meta">{{ note.author.user.first_name|default:note.author.user.email }} • {{ note.created_at|date:"M d, Y g:i A" }}</div>
          <div style="color: #6b7280; margin-top: 4px; font-size: 14px; line-height: 1.4;">
            {{ note.message|truncatechars:150 }}
          </div>
        </div>
        <button class="btn small" onclick="openNotesModal('{{ note.lead.pk }}', '{{ note.lead.title }}')" title="View Notes">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          View Notes
        </button>
      </div>
      {% empty %}
      <div class="muted">No unread notes</div>
      {% endfor %}
    </div>
  </div>
</section>

 



<script>
  (function () {
    var ctx = document.getElementById('leadsOverTimeChart');
    if (!ctx) { return; }
    var labels = [];
    var counts = [];
    try {
      labels = JSON.parse(ctx.dataset.labels || '[]');
      counts = JSON.parse(ctx.dataset.counts || '[]');
    } catch (e) { labels = []; counts = []; }
    function ensureChartJs(cb) {
      if (window.Chart) { cb(); return; }
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
      s.onload = cb; document.body.appendChild(s);
    }
    ensureChartJs(function () {
      var chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Leads',
            data: counts,
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96,165,250,.15)',
            tension: .35,
            fill: true,
            pointRadius: 2,
            borderWidth: 2
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(55,65,81,.25)' } },
            y: { ticks: { color: '#9ca3af', precision: 0 }, grid: { color: 'rgba(55,65,81,.25)' } }
          }
        }
      });
    });
  })();
</script>

<!-- Notes Modal -->
<div id="notesModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="notesModalTitle">Notes</h3>
      <button class="close-btn" onclick="closeNotesModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="notesList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
        <!-- Notes will be loaded here -->
      </div>
      <form id="noteForm" style="display: none;">
        <textarea id="noteMessage" placeholder="Add your note or message here..." rows="4" style="width: 100%; margin-bottom: 10px;"></textarea>
        <div style="text-align: right;">
          <button type="button" class="btn ghost" onclick="closeNotesModal()">Cancel</button>
          <button type="submit" class="btn primary">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let currentLeadId = null;
  
  function openNotesModal(leadId, leadTitle) {
    currentLeadId = leadId;
    document.getElementById('notesModalTitle').textContent = `Notes - ${leadTitle}`;
    document.getElementById('notesModal').style.display = 'block';
    document.getElementById('noteForm').style.display = 'block';
    loadNotes(leadId);
  }
  
  function closeNotesModal() {
    document.getElementById('notesModal').style.display = 'none';
    currentLeadId = null;
  }
  
  function loadNotes(leadId) {
    fetch(`/ui/leads/${leadId}/notes/`)
      .then(response => response.json())
      .then(data => {
        const notesList = document.getElementById('notesList');
        if (data.notes && data.notes.length > 0) {
          notesList.innerHTML = data.notes.map(note => `
            <div style="border-bottom: 1px solid #e5e7eb; padding: 10px 0;">
              <div style="font-weight: 500; color: #374151; margin-bottom: 5px;">
                ${note.author_name} - ${note.created_on_arrow}
              </div>
              <div style="color: #6b7280; line-height: 1.5;">
                ${note.message}
              </div>
            </div>
          `).join('');
        } else {
          notesList.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">No notes yet</div>';
        }
        
        // Refresh the page to update unread notes count in dashboard
        // This ensures the unread notes section updates after marking notes as read
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      })
      .catch(error => {
        console.error('Error loading notes:', error);
        document.getElementById('notesList').innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">Error loading notes</div>';
      });
  }
  
  document.getElementById('noteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const message = document.getElementById('noteMessage').value.trim();
    if (!message) return;
    
    const formData = new FormData();
    formData.append('message', message);
    formData.append('csrfmiddlewaretoken', document.querySelector('input[name="csrfmiddlewaretoken"]').value);
    
    fetch(`/ui/leads/${currentLeadId}/notes/`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('noteMessage').value = '';
        loadNotes(currentLeadId);
      } else {
        alert('Error adding note: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error adding note:', error);
      alert('Error adding note');
    });
  });
  
  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('notesModal');
    if (event.target === modal) {
      closeNotesModal();
    }
  }
</script>

<style>
  .modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  
  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .modal-header h3 {
    margin: 0;
    color: #374151;
  }
  
  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #9ca3af;
  }
  
  .close-btn:hover {
    color: #374151;
  }
  
  .modal-body {
    padding: 20px;
  }
  
  .btn.small {
    padding: 4px 8px;
    font-size: 12px;
    min-width: auto;
  }
</style>
<!-- Notes Modal -->
<div id="notesModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="notesModalTitle">Notes</h3>
      <button class="close-btn" onclick="closeNotesModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="notesList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
        <!-- Notes will be loaded here -->
      </div>
      <form id="noteForm" style="display: none;">
        <textarea id="noteMessage" placeholder="Add your note or message here..." rows="4" style="width: 100%; margin-bottom: 10px;"></textarea>
        <div style="text-align: right;">
          <button type="button" class="btn ghost" onclick="closeNotesModal()">Cancel</button>
          <button type="submit" class="btn primary">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  
  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .modal-header h3 {
    margin: 0;
    color: #374151;
  }
  
  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #9ca3af;
  }
  
  .close-btn:hover {
    color: #374151;
  }
  
  .modal-body {
    padding: 20px;
  }
  
  .btn.small {
    padding: 4px 8px;
    font-size: 12px;
    min-width: auto;
  }
</style>
{% endblock %}